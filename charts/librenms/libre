---
# Source: librenms/charts/librenmsServices/templates/mysql.yaml
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-volume-claim
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: ssd-gold
  resources:
    requests:
      storage: 10Gi
---
# Source: librenms/charts/librenmsServices/templates/redis.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: redis-volume-claim
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: ssd-gold
  resources:
    requests:
      storage: 10Gi
---
# Source: librenms/charts/librenmsServices/templates/rrdcached.yaml
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: rrdcached-volume-claim
spec:
  accessModes:
    - ReadWriteOnce
  storageClassName: ssd-gold
  resources:
    requests:
      storage: 10Gi
---
# Source: librenms/charts/librenmsServices/templates/memcached.yaml
apiVersion: v1
kind: Service
metadata:
  namespace: librenms
  name: memcached
spec:
  type: ClusterIP
  selector:
    component: memcached
  ports:
  - name: memcached
    port: 11211
    targetPort: memcached
---
# Source: librenms/charts/librenmsServices/templates/mysql.yaml
apiVersion: v1
kind: Service
metadata:
  namespace: librenms
  name: mysql
spec:
  type: ClusterIP
  selector:
    component: mysql
  ports:
    - name: mysql
      protocol: TCP
      port: 3306
      targetPort: mysql
---
# Source: librenms/charts/librenmsServices/templates/redis.yaml
apiVersion: v1
kind: Service
metadata:
  namespace: librenms
  name: redis
spec:
  type: ClusterIP
  selector:
    component: redis
  ports:
  - name: redis
    port: 6379
    targetPort: redis
---
# Source: librenms/charts/librenmsServices/templates/rrdcached.yaml
apiVersion: v1
kind: Service
metadata:
  namespace: librenms
  name: rrdcached
spec:
  type: ClusterIP
  selector:
    component: rrdcached
  ports:
  - name: rrdcached
    protocol: TCP
    port: 42217
    targetPort: rrdcached
---
# Source: librenms/templates/application.yaml
apiVersion: v1
kind: Service
metadata:
  namespace: librenms
  name: application
spec:
  type: NodePort
  selector:
    component: application
  ports:
  - name: application
    port: 80
    targetPort: application
---
# Source: librenms/templates/dispatcher.yaml
apiVersion: v1
kind: Service
metadata:
  namespace: librenms
  name: dispatcher
spec:
  clusterIP: None
---
# Source: librenms/templates/application.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  namespace: librenms
  name: application
  labels:
    application: librenms
spec:
  replicas: 1
  selector:
    matchLabels:
      component: application
  template:
    metadata:
      namespace: librenms
      name: application
      labels:
        application: librenms
        component: application
    spec:
      initContainers:
      - name: prepare-volume
        image: docker.io/nick170/librenms-application-prepare-volume:0.1.8
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: application
        env:
        - name: LIBRENMS_MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_mysql_user
        - name: LIBRENMS_MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_mysql_password
        - name: LIBRENMS_REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_redis_password
        - name: LIBRENMS_APPLICATION_KEY
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_application_key
        volumeMounts:
        - name: application-volume
          mountPath: /opt/librenms
      - name: check-mysql
        image: docker.io/nick170/librenms-check-mysql:0.1.8
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: application
        env:
        - name: LIBRENMS_MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_mysql_user
        - name: LIBRENMS_MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_mysql_password
      - name: check-rrdcached
        image: docker.io/nick170/librenms-check-rrdcached:0.1.8
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: application
      - name: check-memcached
        image: docker.io/nick170/librenms-check-memcached:0.1.8
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: application
      - name: check-redis
        image: docker.io/nick170/librenms-check-redis:0.1.8
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: application
        env:
        - name: LIBRENMS_REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_redis_password
      containers:
      - name: php-fpm
        image: docker.io/nick170/librenms-application-php-fpm:0.1.8
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: application
        volumeMounts:
        - name: application-volume
          mountPath: /opt/librenms
        - name: application-socket
          mountPath: /sock
      - name: nginx
        image: docker.io/nick170/librenms-application-nginx:0.1.8
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: application
        volumeMounts:
        - name: application-volume
          mountPath: /opt/librenms
        - name: application-socket
          mountPath: /sock
        ports:
        - name: application
          containerPort: 8000
          protocol: TCP
      volumes:
      - name: application-volume
        emptyDir: {}
      - name: application-socket
        emptyDir:
          medium: Memory
---
# Source: librenms/charts/librenmsServices/templates/memcached.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  namespace: librenms
  name: memcached
  labels:
    application: librenms
spec:
  serviceName: memcached
  selector:
    matchLabels:
      component: memcached
  replicas: 1
  template:
    metadata:
      namespace: librenms
      name: memcached
      labels:
        application: librenms
        component: memcached
    spec:
      containers:
      - name: memcached
        image: docker.io/nick170/librenms-memcached:0.1.8
        envFrom:
          - configMapRef:
              name: memcached
        ports:
        - name: memcached
          containerPort: 11211
          protocol: TCP
---
# Source: librenms/charts/librenmsServices/templates/mysql.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  namespace: librenms
  name: mysql
  labels:
    application: librenms
spec:
  serviceName: mysql
  selector:
    matchLabels:
      component: mysql
  replicas: 1
  template:
    metadata:
      namespace: librenms
      name: mysql
      labels:
        application: librenms
        component: mysql
    spec:
      initContainers:
      - name: create-subpath
        image: docker.io/nick170/librenms-subpath:0.1.8
        imagePullPolicy: Always
        env:
          - name: SUBPATHS
            value: "configuration|database|initialization"
          - name: OWNER
            value: "999"
          - name: GROUP
            value: "999"
        volumeMounts:
          - name: mysql-volume
            mountPath: /volume
      - name: prepare-volume
        image: docker.io/nick170/librenms-mysql-prepare-volume:0.1.8
        imagePullPolicy: Always
        envFrom:
          - configMapRef:
              name: mysql
        volumeMounts:
          - name: mysql-volume
            subPath: configuration
            mountPath: /configuration
          - name: mysql-volume
            subPath: database
            mountPath: /database
          - name: mysql-volume
            subPath: initialization
            mountPath: /initialization
      containers:
        - name: mysql
          image: docker.io/nick170/librenms-mysql:0.1.8
          imagePullPolicy: Always
          envFrom:
            - configMapRef:
                name: mysql
          env:
            - name: MYSQL_ROOT_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: application
                  key: mysql_root_password
            - name: MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: application
                  key: librenms_mysql_user
            - name: MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: application
                  key: librenms_mysql_password
          ports:
            - name: mysql
              containerPort: 33306
              protocol: TCP
          volumeMounts:
            - name: mysql-volume
              subPath: configuration
              mountPath: /etc/mysql/conf.d
            - name: mysql-volume
              subPath: database
              mountPath: /var/lib/mysql
            - name: mysql-volume
              subPath: initialization
              mountPath: /docker-entrypoint-initdb.d
      volumes:
        - name: mysql-volume
          persistentVolumeClaim:
            claimName: mysql-volume-claim
---
# Source: librenms/charts/librenmsServices/templates/redis.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  namespace: librenms
  name: redis
  labels:
    application: librenms
spec:
  serviceName: redis
  selector:
    matchLabels:
      component: redis
  replicas: 1
  template:
    metadata:
      namespace: librenms
      name: redis
      labels:
        application: librenms
        component: redis
    spec:
      initContainers:
      - name: create-subpath
        image: docker.io/nick170/librenms-subpath:0.1.8
        imagePullPolicy: Always
        env:
        - name: SUBPATHS
          value: "data"
        - name: OWNER
          value: "999"
        - name: GROUP
          value: "1000"
        volumeMounts:
        - name: redis-volume
          mountPath: /volume
      containers:
      - name: redis
        image: docker.io/nick170/librenms-redis:0.1.8
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: redis
        env:
        - name: REDIS_REQUIRED_PASSWORD
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_redis_password
        ports:
        - name: redis
          containerPort: 36379
          protocol: TCP
        volumeMounts:
        - name: redis-volume
          subPath: data
          mountPath: /data
      volumes:
      - name: redis-volume
        persistentVolumeClaim:
          claimName: redis-volume-claim
---
# Source: librenms/charts/librenmsServices/templates/rrdcached.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  namespace: librenms
  name: rrdcached
  labels:
    application: librenms
spec:
  serviceName: rrdcached
  selector:
    matchLabels:
      component: rrdcached
  replicas: 1
  template:
    metadata:
      namespace: librenms
      name: rrdcached
      labels:
        application: librenms
        component: rrdcached
    spec:
      initContainers:
      - name: create-subpath
        image: docker.io/nick170/librenms-subpath:0.1.8
        imagePullPolicy: Always
        env:
        - name: SUBPATHS
          value: "data|journal"
        - name: OWNER
          value: "1010"
        - name: GROUP
          value: "1010"
        volumeMounts:
        - name: rrdcached-volume
          mountPath: /volume
      containers:
      - name: rrdcached
        image: docker.io/nick170/librenms-rrdcached:0.1.8
        envFrom:
        - configMapRef:
            name: rrdcached
        ports:
        - name: rrdcached
          containerPort: 42217
          protocol: TCP
        volumeMounts:
        - name: rrdcached-volume
          subPath: data
          mountPath: /data
        - name: rrdcached-volume
          subPath: journal
          mountPath: /journal
      volumes:
      - name: rrdcached-volume
        persistentVolumeClaim:
          claimName: rrdcached-volume-claim
---
# Source: librenms/templates/dispatcher.yaml
apiVersion: apps/v1
kind: StatefulSet
metadata:
  namespace: librenms
  name: dispatcher
  labels:
    application: librenms
spec:
  serviceName: dispatcher
  selector:
    matchLabels:
      component: dispatcher
  replicas: 4
  template:
    metadata:
      namespace: librenms
      name: dispatcher
      labels:
        application: librenms
        component: dispatcher
    spec:
      initContainers:
      - name: check-mysql
        image: docker.io/nick170/librenms-check-mysql:0.1.8
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: application
        env:
        - name: LIBRENMS_MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_mysql_user
        - name: LIBRENMS_MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_mysql_password
      - name: check-rrdcached
        image: docker.io/nick170/librenms-check-rrdcached:0.1.8
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: application
      - name: check-memcached
        image: docker.io/nick170/librenms-check-memcached:0.1.8
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: application
      - name: check-redis
        image: docker.io/nick170/librenms-check-redis:0.1.8
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: application
        env:
        - name: LIBRENMS_REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_redis_password
      containers:
      - name: dispatcher
        image: docker.io/nick170/librenms-dispatcher:0.1.8
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: application
        - configMapRef:
            name: dispatcher
        env:
        - name: LIBRENMS_MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_mysql_user
        - name: LIBRENMS_MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_mysql_password
        - name: LIBRENMS_REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_redis_password
        - name: LIBRENMS_APPLICATION_KEY
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_application_key
---
# Source: librenms/templates/cleanup-application.yaml
apiVersion: batch/v1beta1
kind: CronJob
metadata:
  namespace: librenms
  name: cleanup-application
spec:
  schedule: "30 * * * *"
  jobTemplate:
    spec:
      template:
        spec:
          containers:
          - name: cleanup-application
            image: docker.io/nick170/librenms-cleanup-application:0.1.8
            imagePullPolicy: Always
            envFrom:
            - configMapRef:
                name: application
            env:
            - name: LIBRENMS_MYSQL_USER
              valueFrom:
                secretKeyRef:
                  name: application
                  key: librenms_mysql_user
            - name: LIBRENMS_MYSQL_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: application
                  key: librenms_mysql_password
            - name: LIBRENMS_REDIS_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: application
                  key: librenms_redis_password
            - name: LIBRENMS_APPLICATION_KEY
              valueFrom:
                secretKeyRef:
                  name: application
                  key: librenms_application_key
          restartPolicy: Never
---
# Source: librenms/templates/application.yaml
apiVersion: networking.k8s.io/v1beta1
kind: Ingress
metadata:
  namespace: librenms
  name: application
  annotations:
    cert-manager.io/cluster-issuer: letsencrypt-http01-issuer
    kubernetes.io/ingress.class: nginx
    nginx.ingress.kubernetes.io/auth-response-headers: X-Vouch-User
    nginx.ingress.kubernetes.io/auth-signin: https://login.internet.asn.au/login?url=$scheme://$http_host$request_uri&vouch-failcount=$auth_resp_failcount&X-Vouch-Token=$auth_resp_jwt&error=$auth_resp_err
    nginx.ingress.kubernetes.io/auth-snippet: |
      auth_request_set $auth_resp_jwt $upstream_http_x_vouch_jwt;
      auth_request_set $auth_resp_err $upstream_http_x_vouch_err;
      auth_request_set $auth_resp_failcount $upstream_http_x_vouch_failcount;
    nginx.ingress.kubernetes.io/auth-url: https://login.internet.asn.au/validate
    nginx.ingress.kubernetes.io/rewrite-target: /

spec:
  ingressClassName: nginx
  tls:
    - hosts:
        - "librenms.example.com"
      secretName: "librenms.example.com"

  rules:
  - host: librenms.internet.asn.au
    http:
      paths:
      - path: /
        backend:
          serviceName: application
          servicePort: 80
---
# Source: librenms/templates/secrets.yaml
apiVersion: v1
kind: Secret
metadata:
  namespace: librenms
  name: application
  labels:
    helm.sh/chart: "librenms-0.2.3"
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "0"
type: Opaque
data:
  mysql_root_password: Sm95b3VzLVJlc2lnbmVkLUZpbmlja3kw
  librenms_mysql_user: bGlicmVubXM=
  librenms_mysql_password: Sm95b3VzLVJlc2lnbmVkLUZpbmlja3kw
  librenms_administrative_user: YWRtaW4=
  librenms_administrative_password: TGFudGVybjUtRGlzdHJpY3QtUHJvZ2VueQ==
  librenms_administrative_email: ZGV2b3BzQGl4LmFzbi5hdQ==
  librenms_redis_password: U2tpZXM5LU9ib2UtVW5pbnZpdGVk
  librenms_application_key: YmFzZTY0Ojk4bjBMQnk1dTJITHlWdUEwL1VScHUvZnpKNWkyVFI5ZTRyajNTbThIZDA9
---
# Source: librenms/charts/librenmsServices/templates/configmaps.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: librenms
  name: mysql
  labels:
    helm.sh/chart: "librenmsServices-0.1.8"
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "1"
data:
  MYSQL_INITDB_SKIP_TZINFO: "yes"
  MYSQL_DATABASE: "librenms"
---
# Source: librenms/charts/librenmsServices/templates/configmaps.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: librenms
  name: rrdcached
  labels:
    helm.sh/chart: "librenmsServices-0.1.8"
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "1"
data:
  RRDCACHED_CHUNK_SIZE: "2"
  RRDCACHED_THREAD_COUNT: "2"
  RRDCACHED_FLUSH_INTERVAL: "600"
  RRDCACHED_WRITE_INTERVAL: "300"
  RRDCACHED_WRITE_DELAY: "5"
  RRDCACHED_LOG_LEVEL: "LOG_NOTICE"
---
# Source: librenms/charts/librenmsServices/templates/configmaps.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: librenms
  name: memcached
  labels:
    helm.sh/chart: "librenmsServices-0.1.8"
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "1"
data:
  MEMCACHED_THREAD_COUNT: "2"
  MEMCACHED_CONNECTION_REQUESTS: "10"
  MEMCACHED_LOG_LEVEL: ""
---
# Source: librenms/charts/librenmsServices/templates/configmaps.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: librenms
  name: redis
  labels:
    helm.sh/chart: "librenmsServices-0.1.8"
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "1"
data:
  REDIS_LOG_LEVEL: "notice"
---
# Source: librenms/templates/configmaps.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: librenms
  name: application
  labels:
    helm.sh/chart: "librenms-0.2.3"
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "1"
data:
  LIBRENMS_MYSQL_DATABASE: "librenms"
  LIBRENMS_MYSQL_HOST: "galera-mariadb-galera.galera.svc.cluster.local"
  LIBRENMS_APP_URL: "https://librenms.iaa.local/"
  LIBRENMS_MEMORY_LIMIT: "1024"
  LIBRENMS_BASE_URL: "https://librenms.iaa.local/"
  LIBRENMS_AUTH_MECHANISM: "mysql"
  LIBRENMS_SNMP_PING: "false"
  LIBRENMS_SNMP_PING_RTT: "false"
---
# Source: librenms/templates/configmaps.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  namespace: librenms
  name: dispatcher
  labels:
    helm.sh/chart: "librenms-0.2.3"
  annotations:
    "helm.sh/hook": pre-install
    "helm.sh/hook-weight": "1"
data:
  LIBRENMS_DISPATCHER_POLLER_WORKERS: "24"
  LIBRENMS_DISPATCHER_DISCOVERY_WORKERS: "16"
  LIBRENMS_DISPATCHER_SERVICES_WORKERS: "8"
  LIBRENMS_DISPATCHER_LOG_LEVEL: "-v"
---
# Source: librenms/templates/prepare-database.yaml
apiVersion: batch/v1
kind: Job
metadata:
  namespace: librenms
  name: prepare-database
  labels:
    helm.sh/chart: "librenms-0.2.3"
  annotations:
    "helm.sh/hook": post-install
    "helm.sh/hook-weight": "0"
spec:
  ttlSecondsAfterFinished: 300
  template:
    metadata:
      namespace: librenms
      name: prepare-database
      labels:
        application: librenms
        component: install
    spec:
      securityContext:
        runAsUser: 1010
        runAsGroup: 1010
      initContainers:
      - name: readiness-delay
        image: busybox:latest
        command: ['sh', '-c', "sleep 15"]
      containers:
      - name: prepare-database
        image: docker.io/nick170/librenms-application-prepare-mysql:0.1.8
        imagePullPolicy: Always
        envFrom:
        - configMapRef:
            name: application
        env:
        - name: LIBRENMS_MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_mysql_user
        - name: LIBRENMS_MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_mysql_password
        - name: LIBRENMS_REDIS_PASSWORD
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_redis_password
        - name: LIBRENMS_ADMINISTRATIVE_USER
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_administrative_user
        - name: LIBRENMS_ADMINISTRATIVE_PASSWORD
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_administrative_password
        - name: LIBRENMS_ADMINISTRATIVE_EMAIL
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_administrative_email
        - name: LIBRENMS_APPLICATION_KEY
          valueFrom:
            secretKeyRef:
              name: application
              key: librenms_application_key
      restartPolicy: OnFailure
  backoffLimit: 3
